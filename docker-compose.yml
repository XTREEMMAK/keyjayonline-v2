# docker-compose.yml for KeyJay Online v2
# Container prefix: kjo2_
#
# Usage:
#   npm run docker:init   - First-time: start Directus + Postgres only (local dev)
#   npm run docker:up     - Start all containers (local dev, after token is set)
#   npm run docker:down   - Stop containers
#   npm run docker:logs   - View logs
#   npm run docker:build  - Rebuild app image
#
# Environment Files (Local Development):
#   .env.development  - Dev config (non-secrets, used by npm run dev)
#   .env.local        - Dev secrets (gitignored, used by npm run dev)
#   .env.docker.local - Docker secrets (gitignored, used by npm run docker:*)
#
# Production:
#   .env is auto-generated by GitHub Actions from secrets (not needed locally)
#
# Database Options:
#   Local Postgres:    Use --profile local-db (npm scripts do this automatically)
#   External Postgres: Set DB_HOST to external server, don't use local-db profile
#
# Production (GitHub Actions):
#   USE_LOCAL_POSTGRES=true  → Runs with --profile local-db
#   USE_LOCAL_POSTGRES=false → Runs without profile (external DB)
#
# First-Time Local Docker Setup:
#   1. npm run docker:init
#   2. npm run docker:logs (wait for "Server started at http://0.0.0.0:8055")
#   3. Access http://localhost:8055, login with admin credentials
#   4. Create API token in Directus admin (Settings → Access Tokens)
#   5. Add token to .env.docker.local as DIRECTUS_TOKEN
#   6. npm run docker:up
#
# See docs/DEVELOPMENT.md for detailed setup instructions.

services:
  # ==========================================================================
  # PostgreSQL Database (optional - use profile "local-db" to include)
  # ==========================================================================
  kjo2_postgres:
    image: postgres:15-alpine
    container_name: kjo2_postgres
    profiles: ["local-db"]
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_DATABASE:-kjo_v2_db}
      POSTGRES_USER: ${DB_USER:-kjo_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:?Database password required}
    volumes:
      - kjo2_postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - kjo2_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-kjo_user} -d ${DB_DATABASE:-kjo_v2_db}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # Internal only - uncomment below for debugging
    # ports:
    #   - "5432:5432"

  # ==========================================================================
  # Directus CMS
  # ==========================================================================
  kjo2_directus:
    image: directus/directus:11
    container_name: kjo2_directus
    restart: unless-stopped
    # Note: When using local-db profile, postgres starts first due to network dependency.
    # When using external DB, no local postgres dependency needed.
    environment:
      # Database
      # DB_HOST: kjo2_postgres for local container, or external IP for remote DB
      DB_CLIENT: pg
      DB_HOST: ${DB_HOST:-kjo2_postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_DATABASE: ${DB_DATABASE:-kjo_v2_db}
      DB_USER: ${DB_USER:-kjo_user}
      DB_PASSWORD: ${DB_PASSWORD:?Database password required}

      # Directus Settings
      KEY: ${DIRECTUS_KEY:?Directus key required}
      SECRET: ${DIRECTUS_SECRET:?Directus secret required}
      ADMIN_EMAIL: ${DIRECTUS_ADMIN_EMAIL:-admin@example.com}
      ADMIN_PASSWORD: ${DIRECTUS_ADMIN_PASSWORD:?Admin password required}
      ADMIN_TOKEN: ${DIRECTUS_TOKEN:-}

      # Public URL (for asset URLs)
      PUBLIC_URL: ${DIRECTUS_PUBLIC_URL:-http://localhost:8055}

      # CORS
      CORS_ENABLED: "true"
      CORS_ORIGIN: "true"

      # Storage Configuration
      # Default: local storage for development
      # Production: set STORAGE_LOCATIONS=digitalocean in GitHub Secrets
      STORAGE_LOCATIONS: ${STORAGE_LOCATIONS:-local}

      # Local Storage (used when STORAGE_LOCATIONS=local)
      STORAGE_LOCAL_DRIVER: local
      STORAGE_LOCAL_ROOT: /directus/uploads

      # DigitalOcean Spaces Storage (used when STORAGE_LOCATIONS=digitalocean)
      # Location name must be "digitalocean" to match existing DB file records
      STORAGE_DIGITALOCEAN_DRIVER: "s3"
      STORAGE_DIGITALOCEAN_KEY: ${S3_ACCESS_KEY:-}
      STORAGE_DIGITALOCEAN_SECRET: ${S3_SECRET_KEY:-}
      STORAGE_DIGITALOCEAN_BUCKET: ${S3_BUCKET:-kjo}
      STORAGE_DIGITALOCEAN_REGION: ${S3_REGION:-nyc3}
      STORAGE_DIGITALOCEAN_ENDPOINT: "https://${S3_ENDPOINT:-nyc3.digitaloceanspaces.com}"
      STORAGE_DIGITALOCEAN_ACL: "public-read"
    volumes:
      - kjo2_directus_uploads:/directus/uploads
      - kjo2_directus_extensions:/directus/extensions
      - ./docker/directus:/directus/config:ro
      - ./docker/scripts/first-run.sh:/directus/scripts/first-run.sh:ro
    # Run schema migration script before starting Directus.
    # Entrypoint still runs `npx directus bootstrap` first.
    # Schema apply is idempotent — no-op when schema matches.
    command: ["sh", "-c", "sh /directus/scripts/first-run.sh && npx directus start"]
    networks:
      - kjo2_network
    ports:
      - "${DIRECTUS_PORT:-8055}:8055"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8055/server/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==========================================================================
  # SvelteKit Application
  # ==========================================================================
  kjo2_app:
    # Build section - only used for local development (npm run docker:build)
    # Production uses pre-built image from ghcr.io (set via REGISTRY_IMAGE env var)
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DIRECTUS_URL: http://kjo2_directus:8055
        DIRECTUS_TOKEN: ${DIRECTUS_TOKEN:-}
        PUBLIC_SITE_URL: ${PUBLIC_SITE_URL:-https://example.com}
        CDN_BASE_URL: ${CDN_BASE_URL:-}
        S3_BUCKET_URL: ${S3_BUCKET_URL:-}
        USE_CDN_FOR_ASSETS: ${USE_CDN_FOR_ASSETS:-true}
        NODE_ENV: production
        IGDB_CLIENT_ID: ${IGDB_CLIENT_ID:-placeholder}
        IGDB_ACCESS_TOKEN: ${IGDB_ACCESS_TOKEN:-placeholder}
        DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-placeholder}
        DISCORD_USER_ID: ${DISCORD_USER_ID:-placeholder}
        PUBLIC_CONTACT_EMAIL: ${PUBLIC_CONTACT_EMAIL:-contact@example.com}
    image: ${REGISTRY_IMAGE:-kjo2_app}:${APP_VERSION:-latest}
    container_name: kjo2_app
    restart: unless-stopped
    depends_on:
      kjo2_directus:
        condition: service_healthy
    environment:
      # Runtime environment variables
      NODE_ENV: production
      PORT: 3000

      # Directus connection (internal Docker network)
      DIRECTUS_URL: http://kjo2_directus:8055
      DIRECTUS_TOKEN: ${DIRECTUS_TOKEN:?Directus token required}

      # CDN Configuration
      CDN_BASE_URL: ${CDN_BASE_URL:-}
      USE_CDN_FOR_ASSETS: "true"

      # Public URLs
      PUBLIC_SITE_URL: ${PUBLIC_SITE_URL:-https://example.com}
      PUBLIC_CONTACT_EMAIL: ${PUBLIC_CONTACT_EMAIL:-contact@example.com}

      # Contact Form Webhook
      CONTACT_FORM_WEBHOOK_URL: ${CONTACT_FORM_WEBHOOK_URL:-}
      CONTACT_FORM_WEBHOOK_SECRET: ${CONTACT_FORM_WEBHOOK_SECRET:-}
    networks:
      - kjo2_network
    ports:
      - "${APP_PORT:-3000}:3000"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ==========================================================================
# Networks
# ==========================================================================
networks:
  kjo2_network:
    name: kjo2_network
    driver: bridge

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  kjo2_postgres_data:
    name: kjo2_postgres_data
  kjo2_directus_uploads:
    name: kjo2_directus_uploads
  kjo2_directus_extensions:
    name: kjo2_directus_extensions
