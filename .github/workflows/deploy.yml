name: Deploy Key Jay Online (Docker)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deploy target'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  REGISTRY: ghcr.io
  # Must be lowercase for Docker - hardcoded since github.repository preserves case
  IMAGE_NAME: xtreemmak/keyjayonline-v2/kjo2_app

jobs:
  # ==========================================================================
  # Build and Test Job
  # ==========================================================================
  build-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint
        continue-on-error: true

      - name: Run Svelte check
        run: npm run check
        continue-on-error: true

      - name: Build application (test)
        run: npm run build
        env:
          NODE_ENV: production
          DIRECTUS_URL: http://localhost:8055
          DIRECTUS_TOKEN: test-token
          PUBLIC_SITE_URL: https://keyjayonline.com
          PUBLIC_CONTACT_EMAIL: contact@keyjayonline.com

  # ==========================================================================
  # Build Docker Image
  # ==========================================================================
  build-docker:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value={{date 'YYYYMMDD-HHmmss'}}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            DIRECTUS_URL=${{ secrets.DIRECTUS_URL }}
            DIRECTUS_TOKEN=${{ secrets.DIRECTUS_TOKEN }}
            PUBLIC_SITE_URL=${{ secrets.PUBLIC_SITE_URL }}
            CDN_BASE_URL=${{ secrets.CDN_BASE_URL }}
            S3_BUCKET_URL=${{ secrets.S3_BUCKET_URL }}
            PUBLIC_CONTACT_EMAIL=${{ secrets.PUBLIC_CONTACT_EMAIL }}

  # ==========================================================================
  # Deploy to Production
  # ==========================================================================
  deploy:
    needs: build-docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to production server
        uses: appleboy/ssh-action@v1.0.3
        env:
          # Pass secrets as environment variables for the SSH script
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DIRECTUS_KEY: ${{ secrets.DIRECTUS_KEY }}
          DIRECTUS_SECRET: ${{ secrets.DIRECTUS_SECRET }}
          DIRECTUS_ADMIN_EMAIL: ${{ secrets.DIRECTUS_ADMIN_EMAIL }}
          DIRECTUS_ADMIN_PASSWORD: ${{ secrets.DIRECTUS_ADMIN_PASSWORD }}
          DIRECTUS_TOKEN: ${{ secrets.DIRECTUS_TOKEN }}
          DIRECTUS_PUBLIC_URL: ${{ secrets.DIRECTUS_PUBLIC_URL }}
          S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
          S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
          CDN_BASE_URL: ${{ secrets.CDN_BASE_URL }}
          S3_BUCKET_URL: ${{ secrets.S3_BUCKET_URL }}
          PUBLIC_SITE_URL: ${{ secrets.PUBLIC_SITE_URL }}
          PUBLIC_CONTACT_EMAIL: ${{ secrets.PUBLIC_CONTACT_EMAIL }}
          CONTACT_FORM_WEBHOOK_URL: ${{ secrets.CONTACT_FORM_WEBHOOK_URL }}
          CONTACT_FORM_WEBHOOK_SECRET: ${{ secrets.CONTACT_FORM_WEBHOOK_SECRET }}
          USE_LOCAL_POSTGRES: ${{ secrets.USE_LOCAL_POSTGRES }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: DB_HOST,DB_DATABASE,DB_USER,DB_PASSWORD,DIRECTUS_KEY,DIRECTUS_SECRET,DIRECTUS_ADMIN_EMAIL,DIRECTUS_ADMIN_PASSWORD,DIRECTUS_TOKEN,DIRECTUS_PUBLIC_URL,S3_ACCESS_KEY,S3_SECRET_KEY,CDN_BASE_URL,S3_BUCKET_URL,PUBLIC_SITE_URL,PUBLIC_CONTACT_EMAIL,CONTACT_FORM_WEBHOOK_URL,CONTACT_FORM_WEBHOOK_SECRET,USE_LOCAL_POSTGRES
          script_stop: true
          script: |
            echo "Starting Docker deployment..."

            # Ensure deploy directory exists and has the repo
            if [ ! -d "/var/www/keyjayonline.com/.git" ]; then
              echo "First-time setup: cloning repository..."
              mkdir -p /var/www/keyjayonline.com
              git clone https://github.com/XTREEMMAK/keyjayonline-v2.git /var/www/keyjayonline.com
            fi

            cd /var/www/keyjayonline.com
            git pull origin main

            # Determine database host and profile based on USE_LOCAL_POSTGRES
            if [ "${USE_LOCAL_POSTGRES}" = "true" ]; then
              EFFECTIVE_DB_HOST="kjo2_postgres"
              DOCKER_PROFILE="--profile local-db"
              echo "Using local Postgres container (kjo2_postgres)"
            else
              EFFECTIVE_DB_HOST="${DB_HOST:-external-db-host}"
              DOCKER_PROFILE=""
              echo "Using external Postgres at ${EFFECTIVE_DB_HOST}"
            fi

            # Generate .env from GitHub Secrets (SINGLE SOURCE OF TRUTH)
            echo "Generating .env from GitHub Secrets..."
            cat > .env << EOF
            # =============================================================================
            # AUTO-GENERATED BY GITHUB ACTIONS - DO NOT EDIT MANUALLY
            # Last updated: $(date)
            # =============================================================================

            # Database
            DB_HOST=${EFFECTIVE_DB_HOST}
            DB_PORT=5432
            DB_DATABASE=${DB_DATABASE}
            DB_USER=${DB_USER}
            DB_PASSWORD=${DB_PASSWORD}

            # Directus
            DIRECTUS_KEY=${DIRECTUS_KEY}
            DIRECTUS_SECRET=${DIRECTUS_SECRET}
            DIRECTUS_ADMIN_EMAIL=${DIRECTUS_ADMIN_EMAIL}
            DIRECTUS_ADMIN_PASSWORD=${DIRECTUS_ADMIN_PASSWORD}
            DIRECTUS_TOKEN=${DIRECTUS_TOKEN}
            DIRECTUS_PUBLIC_URL=${DIRECTUS_PUBLIC_URL}

            # S3/Spaces Storage
            S3_ACCESS_KEY=${S3_ACCESS_KEY}
            S3_SECRET_KEY=${S3_SECRET_KEY}
            S3_BUCKET=kjo
            S3_REGION=nyc3
            S3_ENDPOINT=nyc3.digitaloceanspaces.com

            # CDN
            CDN_BASE_URL=${CDN_BASE_URL}
            S3_BUCKET_URL=${S3_BUCKET_URL}
            USE_CDN_FOR_ASSETS=true

            # App
            NODE_ENV=production
            APP_PORT=3000
            PUBLIC_SITE_URL=${PUBLIC_SITE_URL}
            PUBLIC_CONTACT_EMAIL=${PUBLIC_CONTACT_EMAIL}

            # Webhooks
            CONTACT_FORM_WEBHOOK_URL=${CONTACT_FORM_WEBHOOK_URL}
            CONTACT_FORM_WEBHOOK_SECRET=${CONTACT_FORM_WEBHOOK_SECRET}
            EOF

            echo ".env file generated successfully"

            # Login to GitHub Container Registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull the latest image
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

            # Stop existing containers
            docker compose ${DOCKER_PROFILE} down --remove-orphans || true

            # Start containers with new image
            docker compose ${DOCKER_PROFILE} up -d

            # Wait for health checks
            sleep 30

            # Verify deployment
            docker compose ${DOCKER_PROFILE} ps
            docker compose ${DOCKER_PROFILE} logs --tail=20 kjo2_app

            # Clean up old images
            docker image prune -f

            echo "Docker deployment completed successfully!"

      - name: Verify deployment health
        uses: appleboy/ssh-action@v1.0.3
        env:
          USE_LOCAL_POSTGRES: ${{ secrets.USE_LOCAL_POSTGRES }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: USE_LOCAL_POSTGRES
          script: |
            cd /var/www/keyjayonline.com

            # Determine profile based on USE_LOCAL_POSTGRES
            if [ "${USE_LOCAL_POSTGRES}" = "true" ]; then
              DOCKER_PROFILE="--profile local-db"
            else
              DOCKER_PROFILE=""
            fi

            # Check container health
            if docker compose ${DOCKER_PROFILE} ps | grep -q "unhealthy"; then
              echo "ERROR: Container health check failed!"
              docker compose ${DOCKER_PROFILE} logs --tail=50
              exit 1
            fi

            # Check HTTP response
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/)
            if [ "$HTTP_STATUS" != "200" ]; then
              echo "ERROR: Application returned HTTP $HTTP_STATUS"
              exit 1
            fi

            echo "Deployment verified successfully!"

  # ==========================================================================
  # Backup Job (after successful deployment)
  # ==========================================================================
  backup:
    needs: deploy
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Create deployment backup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "Creating backup..."
            BACKUP_DIR="/var/backups/keyjayonline/$(date +%Y%m%d_%H%M%S)"
            sudo mkdir -p $BACKUP_DIR

            # Backup docker volumes
            docker run --rm \
              -v kjo2_postgres_data:/data \
              -v $BACKUP_DIR:/backup \
              alpine tar czf /backup/postgres_data.tar.gz -C /data . || true

            docker run --rm \
              -v kjo2_directus_uploads:/data \
              -v $BACKUP_DIR:/backup \
              alpine tar czf /backup/directus_uploads.tar.gz -C /data . || true

            # Keep only last 5 backups
            sudo find /var/backups/keyjayonline -maxdepth 1 -type d | sort -r | tail -n +6 | sudo xargs rm -rf || true

            echo "Backup created at $BACKUP_DIR"

  # ==========================================================================
  # Security Scan (PRs only)
  # ==========================================================================
  security-scan:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        run: npm audit --audit-level moderate
        continue-on-error: true

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Dockerfile
        continue-on-error: true
